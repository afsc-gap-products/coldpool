---
title: "Update the Cold Pool Index and Average Temperature"
author: 
- affiliation: RACE
  description: Research Fish Biologist
  email: Sean.Rohan@noaa.gov
  name: Sean Rohan
output: word_document
fontsize: 12pt
addr: 
  l1: 7600 Sand Point Way NE
  l2: NMFS RACE Division, Groundfish Assessment Program
  l3: Seattle, WA 98115
---

# Introduction

This document provides code for updating the annual summer Cold Pool Index and average summer bottom temperature for the eastern Bering Sea continental shelf. The data used are collected during AFSC/RACE/GAP bottom trawl surveys of the eastern Bering Sea continental shelf and the code herein is used to interpolate bottom temperature (i.e., gear temperature in RACEBASE), calculate cold pool area and average bottom temperature, produce GeoTIFF rasters of temperature with a 5x5 km resolution, and update data sets that are included with the coldpool package.

# 1. Setup project options

```{r setup, include=TRUE, message=FALSE, warning=FALSE, echo=FALSE}
library(coldpool)

# Set global options ----
fig_res <- 300
proj_crs <- coldpool:::ebs_proj_crs

# Should data included in the package be updated with new data (i.e. for annual update)? ----
update_sysdata <- TRUE

# Filepath to csv containing data to use for temperature interpolation ----
csv_path <- here::here("data", paste0(Sys.Date(), "_index_hauls_temperature_data.csv"))
```

# 2. Retrieve temperature data

Retrieve temperature data and write to:
- /data/[date]_all_temperature_data.csv: Temperature data from all hauls.
- /data/[date]_index_hauls_temperature_data.csv: Temperature data for haul type 3 with good performance. This is the data set that is used for cold pool index calculations.
```{r query_data, include=TRUE, message=FALSE, warning=FALSE}
# Update system data with new cold pool area estimates 

if(update_sysdata) {
  library(getPass)
  # Connect RODBC ----
  channel <- get_connected()
  
  # Get temperature data and write csvs to data directory ----
  get_data(channel = channel)
}
```


# 3. Interpolate bottom and surface temperatures using candidate interpolation methods ----

Conduct interpolation using candidate interpolation methods. GeoTIFF rasters of interpolated gear temperature are saved to output/raster/[variable] for each method and year. 

```{r interpolate, include=TRUE, message=FALSE, warning=FALSE, echo = FALSE}
# Interpolate gear temperature and write rasters
interpolation_wrapper(temp_data_path = csv_path,
                      proj_crs = proj_crs,
                      cell_resolution = 5000, # 5x5 km grid resolution
                      select_years = 1982:2021, 
                      interp_variable = "gear_temperature") 

# Interpolate surface temperature and write rasters
interpolation_wrapper(temp_data_path = csv_path,
                      proj_crs = proj_crs,
                      cell_resolution = 5000, # 5x5 km grid resolution
                      select_years = 1982:2021,
                      interp_variable = "surface_temperature") 
```
# 4. Calculate cold pool area, mean bottom temperature, surface temperature

Tables containing cold pool area and mean bottom temperature are written to .csv files. The interpolation method used for cold pool calculation is ordinary kriging with Stein's Matern covariance.

Writes:
- /output/cpa_out_ste.csv: Cold pool area and mean bottom temperature estimated using ordinary kriging with Stein's Matern variogram
- /output/cpa_out.csv: Cold pool area and mean mean bottom temperature estimated using all candidate interpolation methods.
- /output/raster/[METHOD]_[YEAR]_gear_temperature.tif: GeoTIFF rasters of gear temperature, by method and year, with 5x5 km grid resolution.

```{r}
# Calculate cold pool area and mean bottom temperature from rasters
bottom_temp_files <- list.files(here::here("output", "raster", "gear_temperature"), 
                                full.names = TRUE)
bottom_temp_files <- bottom_temp_files[grep(pattern = "ste_", x = bottom_temp_files)]
year_vec <- numeric(length = length(bottom_temp_files))
bt_lte2 <- numeric(length = length(bottom_temp_files))
bt_lte1 <- numeric(length = length(bottom_temp_files))
bt_lte0 <- numeric(length = length(bottom_temp_files))
bt_lteNeg1 <- numeric(length = length(bottom_temp_files))
bt_mean <- numeric(length = length(bottom_temp_files))

for(i in 1:length(bottom_temp_files)) {
  bt_raster <- raster::raster(bottom_temp_files[i], values = TRUE)
  year_vec[i] <- as.numeric(gsub("[^0-9.-]", "", names(bt_raster))) # Extract year
  bt_lte2[i] <- bt_raster %>% cpa_from_raster(raster_units = "m", temperature_threshold = 2)
  bt_lte1[i] <- bt_raster %>% cpa_from_raster(raster_units = "m", temperature_threshold = 1)
  bt_lte0[i] <- bt_raster %>% cpa_from_raster(raster_units = "m", temperature_threshold = 0)
  bt_lteNeg1[i] <- bt_raster %>% cpa_from_raster(raster_units = "m", temperature_threshold = -1)
  bt_mean[i] <- raster::values(bt_raster) %>% mean(na.rm = TRUE)
  
}

# Calculate mean surface temperature
surface_temp_files <- list.files(here::here("output", "raster", "surface_temperature"), 
                                full.names = TRUE)
surface_temp_files <- surface_temp_files[grep(pattern = "ste_", x = surface_temp_files)]

for(i in 1:length(surface_temp_files)) {
  sst_raster <- raster::raster(surface_temp_files[i], values = TRUE)
  year_vec[i] <- as.numeric(gsub("[^0-9.-]", "", names(sst_raster)))  # Extract year
  sst_mean[i] <- raster::values(sst_raster) %>% mean(na.rm = TRUE)
  }
```

# 5. Add data to R/sysdata ----

Update sysdata with cold pool area, average temperature estimates, and 5-km resolution rasters of temperature in the eastern Bering Sea.

```{r cpa_to_sysdata}
# Write cold pool index and average gear temperature table to R/sysdata.R ----
# Need to update documentation and build/install after running this code.

if(update_sysdata) {
  
  # Make surface temperature raster stack
  ebs_surface_temperature <- coldpool::make_raster_stack(file_path = here::here("output", "raster", "surface_temperature"),
                                                         file_name_contains = "ste_",
                                                         file_type = ".tif")
  
  # Make bottom temperature raster stack
  ebs_bottom_temperature <- coldpool::make_raster_stack(file_path = here::here("output", "raster", "gear_temperature"),
                                                        file_name_contains = "ste_",
                                                        file_type = ".tif")
  
  
  cpa_pre2021 <- coldpool:::cpa_pre2021
  ebs_proj_crs <- coldpool:::ebs_proj_crs
  cold_pool_index <- read.csv(file = here::here("output", "estimated_cpa", "cpa_out_ste.csv")) %>%
    dplyr::rename(COLD_POOL_AREA_KM2 = ste_lte2,
                  LTE0_AREA_KM2 = ste_lte0,
                  MEAN_TEMPERATURE = ste_meantemp,
                  YEAR = year) %>%
    dplyr::mutate(LAST_UPDATE = Sys.Date(),
                  COLDPOOL_VERSION = as.character(utils::packageVersion("coldpool")))
  save(cpa_pre2021, 
       ebs_proj_crs, 
       cold_pool_index,
       ebs_bottom_temperature,
       ebs_surface_temperature,
       file = here::here("R", "sysdata.rda"))
}
```

# 5. Update documentation, install, and restart

Update version number in DESCRIPTION and update documentation using:
```{r updater, eval=FALSE, include=TRUE}
devtools::document(roclets = c('rd', 'collate', 'namespace'))
```

After updating, reinstall the coldpool package:
```{r install, eval=FALSE, include = TRUE}
Rcmd.exe INSTALL --no-multiarch --with-keep.source cold_pool
```

#6. Check that data appears correctly
Check that the updated cold pool index data is included in the package.
```{r qaqc, eval = TRUE, include = TRUE}
print(coldpool:::cold_pool_index)
```